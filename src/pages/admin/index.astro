---
import { db, papers, refreshLogs, desc } from 'astro:db';
import AdminHeader from '~/components/AdminHeader.astro';
import { eq } from 'astro:db';

const totalPapers = await db.select({ count: papers }).from(papers);

const lastRefresh = await db
  .select()
  .from(refreshLogs)
  .orderBy(desc(refreshLogs.date))
  .limit(1);

const lastRefreshLog = lastRefresh[0];

const refreshLogsList = await db
  .select()
  .from(refreshLogs)
  .orderBy(desc(refreshLogs.date))
  .limit(10);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Genetius</title>
  </head>
  <body class="bg-gray-50">
    <AdminHeader />
    <main class="max-w-7xl mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-8">Admin Dashboard</h1>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500 mb-1">Total Papers</p>
          <p class="text-4xl font-bold text-gray-900">{totalPapers.length}</p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500 mb-1">Last Refresh</p>
          <p class="text-xl font-semibold text-gray-900">
            {lastRefreshLog
              ? new Date(lastRefreshLog.date).toLocaleDateString()
              : 'Never'}
          </p>
          <p class="text-sm text-gray-500 mt-1">
            {lastRefreshLog?.status || 'No status'}
          </p>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500 mb-1">Papers Processed</p>
          <p class="text-4xl font-bold text-gray-900">
            {lastRefreshLog?.papersProcessed ?? 0}
          </p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Refresh Data</h2>
        <div id="refreshProgress" class="hidden mb-4">
          <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <div>
              <p id="refreshStatus" class="text-sm text-gray-900"></p>
              <p id="refreshDetails" class="text-xs text-gray-500"></p>
            </div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        <form method="post" action="/admin/refresh" id="refreshForm">
          <button
            type="submit"
            id="refreshButton"
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            Refresh Papers
          </button>
        </form>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Recent Refresh Logs</h2>
        {refreshLogsList.length > 0 ? (
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900">
                  Date
                </th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900">
                  Interval
                </th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900">
                  Fetched
                </th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900">
                  Processed
                </th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900">
                  Status
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {refreshLogsList.map((log) => (
                <tr>
                  <td class="px-4 py-2 text-sm text-gray-900">
                    {new Date(log.date).toLocaleString()}
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-900">
                    {new Date(log.intervalStart).toLocaleDateString()} -{' '}
                    {new Date(log.intervalEnd).toLocaleDateString()}
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-900">
                    {log.papersFetched}
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-900">
                    {log.papersProcessed}
                  </td>
                  <td class="px-4 py-2 text-sm text-gray-900">
                    <span
                      class={`px-2 py-1 rounded text-xs font-semibold ${
                        log.status === 'completed'
                          ? 'bg-green-100 text-green-800'
                          : log.status === 'error'
                          ? 'bg-red-100 text-red-800'
                          : 'bg-yellow-100 text-yellow-800'
                      }`}
                    >
                      {log.status}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <p class="text-gray-500 text-sm">No refresh logs yet.</p>
        )}
      </div>
    </main>
    <script>
      const refreshForm = document.getElementById('refreshForm');
      const refreshButton = document.getElementById('refreshButton');
      const refreshProgress = document.getElementById('refreshProgress');
      const refreshStatus = document.getElementById('refreshStatus');
      const refreshDetails = document.getElementById('refreshDetails');
      const progressBar = document.getElementById('progressBar');

      let pollInterval = null;
      let isRefreshing = false;

      async function checkRefreshStatus() {
        try {
          const response = await fetch('/admin/refresh-status');
          const data = await response.json();

          if (data.status === 'in_progress' && !isRefreshing) {
            isRefreshing = true;
            showProgress(data);
            startPolling();
          } else if (data.status === 'in_progress' && isRefreshing) {
            updateProgress(data);
          } else if (
            data.status === 'completed' ||
            data.status === 'error' ||
            data.status === 'pending'
          ) {
            if (isRefreshing) {
              stopPolling();
              updateProgress(data);
              isRefreshing = false;
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            }
          }
        } catch (error) {
          console.error('Failed to check refresh status:', error);
        }
      }

      function showProgress(data) {
        refreshProgress.classList.remove('hidden');
        refreshButton.disabled = true;
        refreshButton.textContent = 'Refreshing...';
        updateProgress(data);
      }

      function updateProgress(data) {
        if (data.status === 'in_progress') {
          refreshStatus.textContent = 'Fetching and processing papers...';
          refreshDetails.textContent = `Fetched: ${data.papersFetched} | Processed: ${data.papersProcessed}`;
          const progress = data.papersFetched > 0 ? Math.min((data.papersProcessed / data.papersFetched) * 100, 100) : 0;
          progressBar.style.width = `${progress}%`;
        } else if (data.status === 'completed') {
          refreshStatus.textContent = 'Refresh completed!';
          refreshDetails.textContent = `Processed ${data.papersProcessed} papers`;
          progressBar.style.width = '100%';
        } else if (data.status === 'error') {
          refreshStatus.textContent = 'Refresh encountered an error';
          refreshDetails.textContent = 'Check logs for details';
          progressBar.classList.remove('bg-blue-600');
          progressBar.classList.add('bg-red-600');
        }
      }

      function startPolling() {
        pollInterval = setInterval(checkRefreshStatus, 2000);
      }

      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }

      refreshForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(refreshForm);
        fetch('/admin/refresh', {
          method: 'POST',
          body: formData,
        }).then(() => {
          checkRefreshStatus();
        });
      });

      document.addEventListener('DOMContentLoaded', () => {
        checkRefreshStatus();
      });
    </script>
  </body>
</html>
