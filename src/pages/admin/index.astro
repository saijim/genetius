---
import { db, papers, refreshLogs, desc } from "astro:db";
import MainLayout from "~/layouts/MainLayout.astro";

const totalPapers = await db.select({ count: papers }).from(papers);

const lastRefresh = await db
    .select()
    .from(refreshLogs)
    .orderBy(desc(refreshLogs.date))
    .limit(1);

const lastRefreshLog = lastRefresh[0];

const refreshLogsList = await db
    .select()
    .from(refreshLogs)
    .orderBy(desc(refreshLogs.date))
    .limit(10);
---

<MainLayout title="Admin Dashboard - Genetius" currentPage="admin">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-100 mb-8">
            Admin Dashboard
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat bg-base-100 shadow rounded-box">
                <div class="stat-title">Total Papers</div>
                <div class="stat-value">{totalPapers.length}</div>
            </div>

            <div class="stat bg-base-100 shadow rounded-box">
                <div class="stat-title">Last Refresh</div>
                <div class="stat-desc">
                    {
                        lastRefreshLog
                            ? new Date(lastRefreshLog.date).toLocaleDateString()
                            : "Never"
                    }
                </div>
                <div class="stat-desc text-xs mt-1">
                    {lastRefreshLog?.status || "No status"}
                </div>
                <div class="mt-4">
                    <button
                        type="button"
                        id="resetStatusButton"
                        class="btn btn-xs btn-soft"
                    >
                        Reset Stuck Jobs
                    </button>
                </div>
            </div>

            <div class="stat bg-base-100 shadow rounded-box">
                <div class="stat-title">Papers Processed</div>
                <div class="stat-value">{lastRefreshLog?.papersProcessed ?? 0}</div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-100 mb-4">
                Refresh Data
            </h2>
            <div id="refreshProgress" class="hidden mb-4">
                <div class="flex items-center space-x-3">
                    <div
                        class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-400"
                    >
                    </div>
                    <div>
                        <p
                            id="refreshStatus"
                            class="text-sm text-gray-100"
                        >
                        </p>
                        <p
                            id="refreshDetails"
                            class="text-xs text-gray-400"
                        >
                        </p>
                    </div>
                </div>
                <div class="progress progress-primary mt-3">
                    <div
                        id="progressBar"
                        class="progress-bar"
                        style="width: 0%"
                    >
                    </div>
                </div>
            </div>
            <form
                method="post"
                action="/admin/api/refresh"
                id="refreshForm"
                class="space-y-4"
            >
                <div>
                    <label
                        for="daysBack"
                        class="block text-sm font-medium mb-1"
                    >
                        Fetch Range (Days Back)
                    </label>
                    <select
                        name="daysBack"
                        id="daysBack"
                        class="select select-bordered w-full max-w-xs"
                    >
                        <option value="1">Last 24 Hours</option>
                        <option value="3">Last 3 Days</option>
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 2 Weeks</option>
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="120">Last 120 Days</option>
                        <option value="365">Last 365 Days</option>
                    </select>
                    <p class="text-xs text-base-content/60 mt-1">
                        This will attempt to fetch papers from last X days,
                        prioritizing gaps in data.
                    </p>
                </div>
                <button
                    type="submit"
                    id="refreshButton"
                    class="btn btn-primary"
                >
                    Refresh Papers
                </button>
            </form>
        </div>

        <div class="bg-gray-800 rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-100 mb-4">
                Regenerate Trends
            </h2>
            <p class="text-sm text-gray-400 mb-4">
                Trends are calculated dynamically based on existing papers. If
                you are missing trends, it means no papers match the criteria or
                no papers have been fetched yet. Clicking this will reload the
                page.
            </p>
            <form method="post" action="/admin/api/regenerate-trends">
                <button
                    type="submit"
                    class="btn btn-success"
                >
                    Regenerate Trends
                </button>
            </form>
        </div>

        <div class="bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-100 mb-4">
                Recent Refresh Logs
            </h2>
            {
                refreshLogsList.length > 0 ? (
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-100">
                                        Date
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-100">
                                        Interval
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-100">
                                        Fetched
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-100">
                                        Processed
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-100">
                                        Status
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                {refreshLogsList.map((log) => (
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-300">
                                            {new Date(
                                                log.date,
                                            ).toLocaleString()}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-300">
                                            {new Date(
                                                log.intervalStart,
                                            ).toLocaleDateString()}{" "}
                                            -{" "}
                                            {new Date(
                                                log.intervalEnd,
                                            ).toLocaleDateString()}
                                        </td>
                                         <td class="px-4 py-2 text-sm text-gray-300">
                                            {log.papersFetched}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-300">
                                            {log.papersProcessed}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-base-content">
                                            <span
                                                class={`status ${
                                                    log.status === "completed"
                                                        ? "status-success"
                                                        : log.status === "error"
                                                          ? "status-error"
                                                          : "status-warning"
                                                }`}
                                            >
                                                {log.status}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                 ) : (
                    <p class="text-gray-400 text-sm">
                        No refresh logs yet.
                    </p>
                )
            }
        </div>
    </div>
    <script>
        const refreshForm = document.getElementById(
            "refreshForm",
        ) as HTMLFormElement | null;
        const refreshButton = document.getElementById(
            "refreshButton",
        ) as HTMLButtonElement | null;
        const refreshProgress = document.getElementById(
            "refreshProgress",
        ) as HTMLDivElement | null;
        const refreshStatus = document.getElementById(
            "refreshStatus",
        ) as HTMLParagraphElement | null;
        const refreshDetails = document.getElementById(
            "refreshDetails",
        ) as HTMLParagraphElement | null;
        const progressBar = document.getElementById(
            "progressBar",
        ) as HTMLDivElement | null;

        let pollInterval: ReturnType<typeof setInterval> | null = null;
        let isRefreshing = false;

        async function checkRefreshStatus() {
            try {
                const response = await fetch("/admin/api/refresh-status");
                const data = await response.json();

                if (data.status === "in_progress" && !isRefreshing) {
                    isRefreshing = true;
                    showProgress(data);
                    startPolling();
                } else if (data.status === "in_progress" && isRefreshing) {
                    updateProgress(data);
                } else if (
                    data.status === "completed" ||
                    data.status === "error" ||
                    data.status === "pending"
                ) {
                    if (isRefreshing) {
                        stopPolling();
                        updateProgress(data);
                        isRefreshing = false;
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error("Failed to check refresh status:", error);
            }
        }

        function showProgress(data: any) {
            if (!refreshProgress || !refreshButton) return;
            refreshProgress.classList.remove("hidden");
            refreshButton.disabled = true;
            refreshButton.textContent = "Refreshing...";
            updateProgress(data);
        }

        function updateProgress(data: any) {
            if (!refreshStatus || !refreshDetails || !progressBar) return;

            if (data.status === "in_progress") {
                refreshStatus.textContent = "Fetching and processing papers...";
                refreshDetails.textContent = `Fetched: ${data.papersFetched} | Processed: ${data.papersProcessed}`;
                const progress =
                    data.papersFetched > 0
                        ? Math.min(
                              (data.papersProcessed / data.papersFetched) * 100,
                              100,
                          )
                        : 0;
                progressBar.style.width = `${progress}%`;
            } else if (data.status === "completed") {
                refreshStatus.textContent = "Refresh completed!";
                refreshDetails.textContent = `Processed ${data.papersProcessed} papers`;
                progressBar.style.width = "100%";
            } else if (data.status === "error") {
                refreshStatus.textContent = "Refresh encountered an error";
                refreshDetails.textContent = "Check logs for details";
                progressBar.classList.remove("bg-blue-600");
                progressBar.classList.add("bg-red-600");
            }
        }

        function startPolling() {
            pollInterval = setInterval(checkRefreshStatus, 2000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        if (refreshForm) {
            refreshForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const formData = new FormData(refreshForm);
                fetch("/admin/api/refresh", {
                    method: "POST",
                    body: formData,
                }).then(() => {
                    checkRefreshStatus();
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            checkRefreshStatus();
        });

        const resetStatusButton = document.getElementById('resetStatusButton');
        if (resetStatusButton) {
            resetStatusButton.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to manually reset all "in_progress" jobs to "interrupted"? Only do this if you are sure no job is currently running.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/admin/api/reset-status', { method: 'POST' });
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('Reset successful. Reloading...');
                        window.location.reload();
                    } else {
                        alert('Failed to reset: ' + (result.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error resetting status');
                }
            });
        }
    </script>
</MainLayout>
