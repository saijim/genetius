---
import { db, papers, refreshLogs, desc } from "astro:db";
import AdminHeader from "~/components/AdminHeader.astro";
import MainLayout from "~/layouts/MainLayout.astro";

const totalPapers = await db.select({ count: papers }).from(papers);

const lastRefresh = await db
    .select()
    .from(refreshLogs)
    .orderBy(desc(refreshLogs.date))
    .limit(1);

const lastRefreshLog = lastRefresh[0];

const refreshLogsList = await db
    .select()
    .from(refreshLogs)
    .orderBy(desc(refreshLogs.date))
    .limit(10);
---

<MainLayout title="Admin Dashboard - Genetius">
    <AdminHeader />
    <div class="max-w-7xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8">
            Admin Dashboard
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">
                    Total Papers
                </p>
                <p class="text-4xl font-bold text-gray-900 dark:text-gray-100">
                    {totalPapers.length}
                </p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">
                    Last Refresh
                </p>
                <p
                    class="text-xl font-semibold text-gray-900 dark:text-gray-100"
                >
                    {
                        lastRefreshLog
                            ? new Date(lastRefreshLog.date).toLocaleDateString()
                            : "Never"
                    }
                </p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    {lastRefreshLog?.status || "No status"}
                </p>
                <div class="mt-4">
                    <button
                        type="button"
                        id="resetStatusButton"
                        class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded transition-colors"
                    >
                        Reset Stuck Jobs
                    </button>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">
                    Papers Processed
                </p>
                <p class="text-4xl font-bold text-gray-900 dark:text-gray-100">
                    {lastRefreshLog?.papersProcessed ?? 0}
                </p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
                Refresh Data
            </h2>
            <div id="refreshProgress" class="hidden mb-4">
                <div class="flex items-center space-x-3">
                    <div
                        class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 dark:border-blue-400"
                    >
                    </div>
                    <div>
                        <p
                            id="refreshStatus"
                            class="text-sm text-gray-900 dark:text-gray-100"
                        >
                        </p>
                        <p
                            id="refreshDetails"
                            class="text-xs text-gray-500 dark:text-gray-400"
                        >
                        </p>
                    </div>
                </div>
                <div
                    class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-3"
                >
                    <div
                        id="progressBar"
                        class="bg-blue-600 dark:bg-blue-500 h-2 rounded-full transition-all duration-300"
                        style="width: 0%"
                    >
                    </div>
                </div>
            </div>
            <form
                method="post"
                action="/admin/refresh"
                id="refreshForm"
                class="space-y-4"
            >
                <div>
                    <label
                        for="daysBack"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                    >
                        Fetch Range (Days Back)
                    </label>
                    <select
                        name="daysBack"
                        id="daysBack"
                        class="block w-full max-w-xs pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                    >
                        <option value="1">Last 24 Hours</option>
                        <option value="3">Last 3 Days</option>
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 2 Weeks</option>
                        <option value="30">Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="120">Last 120 Days</option>
                        <option value="365">Last 365 Days</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        This will attempt to fetch papers from the last X days,
                        prioritizing gaps in data.
                    </p>
                </div>
                <button
                    type="submit"
                    id="refreshButton"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded transition-colors"
                >
                    Refresh Papers
                </button>
            </form>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
                Regenerate Trends
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Trends are calculated dynamically based on existing papers. If
                you are missing trends, it means no papers match the criteria or
                no papers have been fetched yet. Clicking this will reload the
                page.
            </p>
            <form method="post" action="/admin/regenerate-trends">
                <button
                    type="submit"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white rounded transition-colors"
                >
                    Regenerate Trends
                </button>
            </form>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
                Recent Refresh Logs
            </h2>
            {
                refreshLogsList.length > 0 ? (
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                                        Date
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                                        Interval
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                                        Fetched
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                                        Processed
                                    </th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                                        Status
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {refreshLogsList.map((log) => (
                                    <tr>
                                        <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-300">
                                            {new Date(
                                                log.date,
                                            ).toLocaleString()}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-300">
                                            {new Date(
                                                log.intervalStart,
                                            ).toLocaleDateString()}{" "}
                                            -{" "}
                                            {new Date(
                                                log.intervalEnd,
                                            ).toLocaleDateString()}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-300">
                                            {log.papersFetched}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-300">
                                            {log.papersProcessed}
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-300">
                                            <span
                                                class={`px-2 py-1 rounded text-xs font-semibold ${
                                                    log.status === "completed"
                                                        ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"
                                                        : log.status === "error"
                                                          ? "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"
                                                          : "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"
                                                }`}
                                            >
                                                {log.status}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                ) : (
                    <p class="text-gray-500 dark:text-gray-400 text-sm">
                        No refresh logs yet.
                    </p>
                )
            }
        </div>
    </div>
    <script>
        const refreshForm = document.getElementById(
            "refreshForm",
        ) as HTMLFormElement | null;
        const refreshButton = document.getElementById(
            "refreshButton",
        ) as HTMLButtonElement | null;
        const refreshProgress = document.getElementById(
            "refreshProgress",
        ) as HTMLDivElement | null;
        const refreshStatus = document.getElementById(
            "refreshStatus",
        ) as HTMLParagraphElement | null;
        const refreshDetails = document.getElementById(
            "refreshDetails",
        ) as HTMLParagraphElement | null;
        const progressBar = document.getElementById(
            "progressBar",
        ) as HTMLDivElement | null;

        let pollInterval: ReturnType<typeof setInterval> | null = null;
        let isRefreshing = false;

        async function checkRefreshStatus() {
            try {
                const response = await fetch("/admin/refresh-status");
                const data = await response.json();

                if (data.status === "in_progress" && !isRefreshing) {
                    isRefreshing = true;
                    showProgress(data);
                    startPolling();
                } else if (data.status === "in_progress" && isRefreshing) {
                    updateProgress(data);
                } else if (
                    data.status === "completed" ||
                    data.status === "error" ||
                    data.status === "pending"
                ) {
                    if (isRefreshing) {
                        stopPolling();
                        updateProgress(data);
                        isRefreshing = false;
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error("Failed to check refresh status:", error);
            }
        }

        function showProgress(data: any) {
            if (!refreshProgress || !refreshButton) return;
            refreshProgress.classList.remove("hidden");
            refreshButton.disabled = true;
            refreshButton.textContent = "Refreshing...";
            updateProgress(data);
        }

        function updateProgress(data: any) {
            if (!refreshStatus || !refreshDetails || !progressBar) return;

            if (data.status === "in_progress") {
                refreshStatus.textContent = "Fetching and processing papers...";
                refreshDetails.textContent = `Fetched: ${data.papersFetched} | Processed: ${data.papersProcessed}`;
                const progress =
                    data.papersFetched > 0
                        ? Math.min(
                              (data.papersProcessed / data.papersFetched) * 100,
                              100,
                          )
                        : 0;
                progressBar.style.width = `${progress}%`;
            } else if (data.status === "completed") {
                refreshStatus.textContent = "Refresh completed!";
                refreshDetails.textContent = `Processed ${data.papersProcessed} papers`;
                progressBar.style.width = "100%";
            } else if (data.status === "error") {
                refreshStatus.textContent = "Refresh encountered an error";
                refreshDetails.textContent = "Check logs for details";
                progressBar.classList.remove("bg-blue-600");
                progressBar.classList.add("bg-red-600");
            }
        }

        function startPolling() {
            pollInterval = setInterval(checkRefreshStatus, 2000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        if (refreshForm) {
            refreshForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const formData = new FormData(refreshForm);
                fetch("/admin/refresh", {
                    method: "POST",
                    body: formData,
                }).then(() => {
                    checkRefreshStatus();
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            checkRefreshStatus();
        });

        const resetStatusButton = document.getElementById('resetStatusButton');
        if (resetStatusButton) {
            resetStatusButton.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to manually reset all "in_progress" jobs to "interrupted"? Only do this if you are sure no job is currently running.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/admin/reset-status', { method: 'POST' });
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('Reset successful. Reloading...');
                        window.location.reload();
                    } else {
                        alert('Failed to reset: ' + (result.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error resetting status');
                }
            });
        }
    </script>
</MainLayout>
