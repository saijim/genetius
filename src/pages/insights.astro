---
import MainLayout from '~/layouts/MainLayout.astro';
import { getInsights } from '~/lib/insights';

export const prerender = false;

let insights;
let error;

try {
  insights = await getInsights();
} catch (e) {
  console.error('Failed to load insights:', e);
  error = 'Unable to load insights at this time.';
}

const { momentum = [], network = [], methods = [], clusters = [] } = insights || {};
---

<MainLayout title="Research Insights" currentPage="insights">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-100 mb-8">Research Insights</h1>

    {error && (
      <div class="alert alert-error mb-8">
        <p class="text-sm">{error}</p>
      </div>
    )}

    {!error && (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        {/* Momentum Section */}
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <h2 class="card-title flex items-center">
              <span class="mr-2">ðŸš€</span> Topic Momentum
            </h2>
            <p class="text-sm text-base-content/70 mb-4">Keywords surging in the last 30 days relative to previous 6 months.</p>
            <div class="space-y-3">
              {momentum.length === 0 ? <p class="text-base-content/50 italic">Not enough data yet.</p> : momentum.map((m) => (
                <div class="flex items-center justify-between border-b border-base-content/20 pb-2 last:border-0">
                  <span class="font-medium">{m.keyword}</span>
                  <span class="badge badge-success">
                    +{m.momentum.toFixed(1)}x
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Methods Section */}
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <h2 class="card-title flex items-center">
              <span class="mr-2">ðŸ”¬</span> Top Methods
            </h2>
            <p class="text-sm text-base-content/70 mb-4">Most frequently cited techniques and methods in recent papers.</p>
            <div class="space-y-3">
               {methods.length === 0 ? <p class="text-base-content/50 italic">Not enough data yet.</p> : methods.map((m) => (
                <div class="flex items-center justify-between border-b border-base-content/20 pb-2 last:border-0">
                  <span class="font-medium">{m.method}</span>
                  <span class="text-sm text-base-content/60">{m.count} papers</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Clusters Section */}
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <h2 class="card-title flex items-center">
              <span class="mr-2">ðŸ”—</span> Topic Clusters
            </h2>
            <p class="text-sm text-base-content/70 mb-4">Keywords that frequently appear together.</p>
            <div class="flex flex-wrap gap-2">
              {clusters.length === 0 ? <p class="text-base-content/50 italic">Not enough data yet.</p> : clusters.map((c) => (
                <span class="badge badge-primary">
                  {c.keyword1} + {c.keyword2}
                </span>
              ))}
            </div>
          </div>
        </div>

        {/* Network Section */}
        <div class="card bg-base-100 shadow">
          <div class="card-body">
            <h2 class="card-title flex items-center">
              <span class="mr-2">ðŸ‘¥</span> Collaborations
            </h2>
            <p class="text-sm text-base-content/70 mb-4">Frequent author collaborations.</p>
            <div class="space-y-3">
              {network.length === 0 ? <p class="text-base-content/50 italic">Not enough data yet.</p> : network.map((n) => (
                <div class="flex items-center justify-between border-b border-base-content/20 pb-2 last:border-0">
                  <div class="text-sm">
                    <span class="font-medium">{n.author1}</span> & <span class="font-medium">{n.author2}</span>
                  </div>
                  <span class="text-xs text-base-content/50">{n.weight} papers</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    )}
  </div>
</Layout>
